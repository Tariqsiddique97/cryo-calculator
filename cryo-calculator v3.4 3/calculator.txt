<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cryo Tank Calculator + SCF Split (Swipe)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin:0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-text-size-adjust: 100%;
      background: Canvas; color: CanvasText;
    }

    /* Swipe container */
    .viewport{position:fixed; inset:0; overflow:hidden;}
    .panes{display:flex; width:300vw; height:100%; transform:translateX(0); transition:transform .25s ease-out}
    .panes[data-index="1"]{ transform:translateX(-100vw); }
    .panes[data-index="2"]{ transform:translateX(-200vw); }
    .pane{width:100vw; height:100%; overflow:auto; -webkit-overflow-scrolling:touch; }

    /* Enough bottom space so last inputs/buttons aren't cut off */
    .pane .page{ padding-bottom: calc(env(safe-area-inset-bottom) + 140px); }
    @supports (height: 100dvh){ .viewport{ height: 100dvh; } }

    /* Page padding */
    .page { padding: calc(env(safe-area-inset-top) + 20px) 20px calc(env(safe-area-inset-bottom) + 20px); max-width: 720px; margin: 0 auto; }

    /* HUD hint */
    .hint{position:fixed;left:12px;right:12px;bottom:12px;text-align:center;color:#667085;font-size:12px;opacity:.9;pointer-events:none;z-index:10}
    .dots{display:inline-flex;gap:6px;align-items:center;margin-left:8px}
    .dot{width:6px;height:6px;border-radius:999px;background:#cbd5e1;display:inline-block}
    .dot.active{background:#22c55e}
    .swipe{display:inline-block;border:1px solid #cbd5e1;border-radius:999px;padding:4px 8px}

    /* Base UI */
    h1 { margin: 0 0 6px; font-weight: 700; font-size: 22px; }
    h2 { margin-top: 20px; font-size: 18px; }
    label { display: block; margin-top: 10px; }
    input, select, button {
      font-size: 16px;
      padding: 10px 12px; width: 100%; margin-top: 6px; box-sizing: border-box;
      border-radius: 10px; border: 1px solid #c9c9c9; background: Field; color: FieldText;
      -webkit-appearance: none; font-family: inherit;
    }
    input::placeholder { color: #999; }

    /* Buttons (blue theme) */
    button { cursor: pointer; border: none; background: #1a73e8; color: #fff; font-weight: 600;
      box-shadow: 0 1px 2px rgb(0 0 0 / .1); transition: filter .15s ease; width: auto;
      padding: 10px 14px; border-radius: 10px; }
    .btn-primary{ background:#1a73e8 !important; color:#fff; }
    button:disabled { opacity: .6; }
    button:active { filter: brightness(.95); }
    .btn-clear { background: #eee; color: #111; border: 1px solid #ccc; }
    .btn-ghost{ background: transparent; color: #1a73e8; border:1px solid #cbd5e1; }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width:520px){ .row2{ grid-template-columns:1fr; } }
    .muted { color:#666; font-size:12px; margin-top:4px; }
    .box  { background:#f7f7f8; border-radius:12px; padding:12px; margin-top:12px; }
    .inline { display:inline-block; min-width: 140px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .result { margin-top: 16px; padding: 12px; background: #f4f4f4; border-radius: 10px; }
    .actions { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }

    /* Flow Unit Toggle */
    .toggle-wrap { display:flex; align-items:center; gap:10px; margin-top:6px; }
    .switch { position: relative; width: 68px; height: 32px; background: #e6e6e6; border-radius: 999px; border:1px solid #ccc; display: inline-block; cursor: pointer; flex-shrink: 0; }
    .switch input { display: none; }
    .knob { position: absolute; top: 2px; left: 2px; width: 28px; height: 28px; border-radius: 50%; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.15); transition: left .18s ease; }
    .switch.on { background: #cfe1ff; border-color: #9ec2ff; }
    .switch.on .knob { left: 38px; }
    .unit-legend { position:absolute; top:50%; transform: translateY(-50%); font-size:11px; color:#333; pointer-events:none; width:100%; display:flex; justify-content:space-between; padding:0 8px; }
    .unit-legend span { opacity:.7; }
    .switch.on .unit-legend .lb { font-weight:700; opacity:1; }
    .switch:not(.on) .unit-legend .gal { font-weight:700; opacity:1; }

    /* Split/Reserve page tweaks */
    .split h1{ margin:0 0 8px; font-size:22px; }
    .split .btn{ width:100%; }
    .err{margin-top:8px;color:#b42318;background:#ffefef;border:1px solid #f3b3b0;padding:10px;border-radius:10px;display:none}

    /* Dynamic compact mode for short screens */
    .compact .page { padding: 12px 14px 14px; }
    .compact label { margin-top: 3px; }
    .compact input, .compact select, .compact button { margin-top: 2px; padding: 8px 10px; font-size: 15px; }
    .compact .row2 { gap: 6px; }
    .compact .box { padding: 8px; margin-top: 8px; }
    .compact .result { margin-top: 10px; padding: 10px; }
    .compact .actions { gap: 8px; margin-top: 8px; }
    .compact h1, .compact .split h1 { margin-bottom: 4px; font-size: 20px; }
    .compact .btn { padding: 10px 12px; }

    /* Sticky action bars on Split/Reserve pages */
    #pane-split #calcSplit { position: sticky; bottom: calc(env(safe-area-inset-bottom) + 8px); width: 100%; z-index: 9; }
    .sticky-actions{ position: sticky; bottom: calc(env(safe-area-inset-bottom) + 8px); display:flex; gap:10px; align-items:center; background: Canvas; padding-top:10px; z-index: 9; }
    .sticky-actions .btn{ width:100%; }
    .sticky-actions .btn-clear{ width:100%; }

    /* Modal */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.4);
      display:none; align-items:center; justify-content:center; z-index: 1000;
    }
    .modal.open { display:flex; }
    .modal-card{
      width:min(560px, 94vw);
      background: Canvas; color: CanvasText; border-radius:16px; padding:16px 16px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .modal h3{ margin:0 0 6px; font-size:18px; }
    .modal .steps{ font-size:14px; color:#555; margin:8px 0 10px; }
    .modal .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .modal .badge{ display:inline-block; background:#eef2ff; color:#1a73e8; border:1px solid #c7d2fe; border-radius:999px; padding:4px 10px; font-size:12px; }
    .modal .muted { color:#666; margin-top:4px; }
    .modal .actions{ display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }
    .pill{ border-radius:999px; }
    .dotA,.dotB,.dotC{color:#dc2626;font-weight:700}

    /* --- NEW: Photo Measure + tabs --- */
    .tabbar{display:flex;gap:8px;margin:6px 0 10px}
    .tabbtn{padding:6px 10px;border:1px solid #cbd5e1;border-radius:999px;background:#eef2ff;color:#0f172a;font-weight:600;cursor:pointer}
    .tabbtn.active{background:#1a73e8;color:#fff;border-color:#99b6f9}
    .pm-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .pm-canvas-wrap{background:#0a0a0a;border-radius:12px;padding:8px}
    #pmCanvas{display:block;max-width:100%;border-radius:8px;background:#111}
    .pm-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pm-muted{font-size:12px;color:#666;margin-top:4px}
  </style>
</head>
<body>
  <div class="viewport" id="viewport">
    <div class="panes" id="panes" data-index="0">

      <!-- === PAGE: CALCULATOR START === -->
<section class="pane" id="pane-calc">
  <div class="page">
    <h1>Cryo Tank Calculator</h1>
    <div class="muted">
      Tip: For laydown tanks, <b>Full Inches</b> means the Full Trycock inches when the tank is at ‚Äúfull.‚Äù<br>
      A-B-C measures cylinder <i>diameter</i> and <i>length</i> only ‚Äî it does <b>not</b> measure Full Trycock height.
    </div>

    <label>Tank Type:
      <select id="tankType">
        <option value="vertical" selected>Vertical Tank</option>
        <option value="laydown">Laydown (Horizontal Tank)</option>
      </select>
    </label>

    <label>Full Inches (Full Trycock at ‚Äúfull‚Äù):
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="fullInches" type="number" placeholder="0">
        <button id="btnMeasure" type="button" class="btn-ghost">Measure (A-B-C)</button>
      </div>
      <div class="muted">Use <b>Measure (A-B-C)</b> for cylinder size. This will <b>not</b> overwrite Full Trycock inches.</div>
    </label>

    <!-- Geometry fields (hidden until Laydown selected) -->
    <div id="geoFields" hidden>
      <div class="row2">
        <label>Tank Diameter (in)
          <input id="geoDiameter" type="number" placeholder="e.g., 72" disabled>
          <div class="muted">Enter manually or auto-filled from A-B-C. Used for laydown geometry.</div>
        </label>
        <label>Tank Length (in)
          <input id="geoLength" type="number" placeholder="e.g., 300" disabled>
          <div class="muted">Enter manually or auto-filled from A-B-C. Informational; SCF uses Full Capacity.</div>
        </label>
      </div>
      <div id="diamHint" class="muted" hidden></div>
    </div>

    <label>Full Capacity:
      <div style="display:flex;gap:6px">
        <input id="fullCap" type="number" placeholder="0">
        <select id="capUnit">
          <option value="scf" selected>SCF</option>
          <option value="gal">Gallons</option>
        </select>
      </div>
      <div class="muted">Enter the tank‚Äôs rated capacity at ‚Äúfull.‚Äù</div>
    </label>

    <label>Select Gas:
      <select id="gas">
        <option value="LIN">LIN (Nitrogen)</option>
        <option value="LOX">LOX (Oxygen)</option>
        <option value="LAR">LAR (Argon)</option>
      </select>
    </label>

    <div class="row2">
      <div><label>Start Inches:<input id="startInches" type="number" placeholder="0"></label></div>
      <div><label>End Inches:<input id="endInches" type="number" placeholder="0"></label></div>
    </div>
    <div class="muted">Enter the change in Full Trycock inches (End ‚àí Start). Laydown inches are mapped via geometry using the cylinder diameter.</div>

    <!-- Timer + Flow -->
    <div class="box">
      <b>Timer (optional)</b>
      <div class="muted">Use the timer and average flow to estimate transfer. You can also estimate the tank diameter from timer data.</div>

      <div style="margin-top:8px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="btnStart" type="button" class="btn-primary">Start Timer</button>
        <button id="btnStop" type="button" class="btn-clear" disabled>Stop Timer</button>
        <span class="inline mono" id="elapsed">Elapsed: 00:00:00</span>
      </div>

      <div class="row2" style="margin-top:8px;">
        <div>
          <label>Avg Flow
            <div class="toggle-wrap">
              <input type="number" inputmode="decimal" id="flowValue" placeholder="enter value" style="flex:1;">
              <div id="unitSwitch" class="switch" role="switch" aria-checked="false" tabindex="0" title="Toggle gallons ‚Üî pounds per minute">
                <div class="unit-legend"><span class="gal">gal</span><span class="lb">lb</span></div>
                <div class="knob"></div>
              </div>
            </div>
            <div class="muted">Toggle left = Gallons/min (default), right = Pounds/min.</div>
          </label>
        </div>
        <div style="display:flex;align-items:end; gap:12px; flex-wrap:wrap;">
          <label style="display:flex;gap:8px;align-items:center;">
            <input type="checkbox" id="chkEstimateD" style="width:auto;">
            <span>Estimate diameter from timer</span>
          </label>
          <label style="display:flex;gap:8px;align-items:center;">
            <input type="checkbox" id="useTimerPrimary" style="width:auto;">
            <span>Use timer as primary (ignore inches for total)</span>
          </label>
        </div>
      </div>

      <div class="muted">
        When ‚ÄúUse timer as primary‚Äù is on, total moved = (elapsed minutes √ó Flow) ‚Üí converted to SCF by gas. Inches still show as a cross-check.
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" type="button" onclick="calculate()">Calculate</button>
      <button class="btn-clear" type="button" onclick="clearForm()">Clear</button>
      <button type="button" class="btn-primary" onclick="window.goToSplit()">‚Üí Split</button>
    </div>

    <div class="result" id="output">Enter values and tap Calculate.</div>
  </div>
</section>
<!-- === PAGE: CALCULATOR END === -->

      <!-- === PAGE: SPLIT START === -->
<section class="pane" id="pane-split">
  <div class="page split">
    <h1>Cryo Split Calculator</h1>

    <label>Total SCF
      <input id="totalScf" type="number" placeholder="0">
      <div class="muted">Auto-fills after Calculate.</div>
    </label>

    <!-- Tank 1 -->
    <div class="box">
      <b>Tank 1</b>
      <div class="row2" style="align-items:center; margin-bottom:6px;">
        <label>Units
          <select id="t1unit">
            <option value="in" selected>Full Trycock (in)</option>
            <option value="gal">Gallons (gal)</option>
          </select>
        </label>
        <label>Tank Capacity (gal)
          <input id="t1Cap" type="number" placeholder="0">
        </label>
      </div>

      <div class="row2" style="align-items:end;">
        <div>
          <input id="t1s" type="number" placeholder="0">
          <div class="muted">Start</div>
        </div>
        <div>
          <input id="t1e" type="number" placeholder="0">
          <div class="muted">End</div>
        </div>
      </div>
      <label>Total Allocated SCF
        <input id="t1alloc" type="text" placeholder="0" readonly>
      </label>
    </div>

    <!-- Tank 2 -->
    <div class="box">
      <b>Tank 2</b>
      <div class="row2" style="align-items:center; margin-bottom:6px;">
        <label>Units
          <select id="t2unit">
            <option value="in" selected>Full Trycock (in)</option>
            <option value="gal">Gallons (gal)</option>
          </select>
        </label>
        <label>Tank Capacity (gal)
          <input id="t2Cap" type="number" placeholder="0">
        </label>
      </div>

      <div class="row2" style="align-items:end;">
        <div>
          <input id="t2s" type="number" placeholder="0">
          <div class="muted">Start</div>
        </div>
        <div>
          <input id="t2e" type="number" placeholder="0">
          <div class="muted">End</div>
        </div>
      </div>
      <label>Total Allocated SCF
        <input id="t2alloc" type="text" placeholder="0" readonly>
      </label>
    </div>

    <div id="err" class="err">
      Enter Total SCF and matching units. If ‚ÄúGallons‚Äù is selected, use each tank‚Äôs capacity and gallon change to calculate the split.
    </div>

    <div class="sticky-actions">
      <button id="calcSplit" class="btn btn-primary">Calculate</button>
      <button id="clearSplit" class="btn-clear" type="button" style="margin-top:0;width:100%;">Clear</button>
      <button type="button" class="btn btn-primary" onclick="window.goToReserve()">‚Üí Reserve</button>
    </div>
  </div>
</section>
<!-- === PAGE: SPLIT END === -->

      <!-- === PAGE: RESERVE START === -->
<section class="pane" id="pane-reserve">
  <div class="page split">
    <h1>Cryo Reserve Calculator</h1>

    <label>Total Pounds to SCF
      <div style="display:flex; gap:10px; align-items:center;">
        <input id="resGallons" type="number" placeholder="0" maxlength="6" max="999999" inputmode="numeric">
        <button id="resUpdate" type="button" class="btn btn-primary">Update</button>
      </div>
      <div class="muted">
        Pounds on COA translated to SCF (uses gas below, max 6 digits). SCF is capped at 999,999 for the truck counter.
      </div>
      <div id="resHint" class="muted" style="margin-top:6px;"></div>
    </label>

    <label>Gas for Conversion
      <select id="resGas">
        <option value="LIN">LIN (Nitrogen)</option>
        <option value="LOX">LOX (Oxygen)</option>
        <option value="LAR">LAR (Argon)</option>
      </select>
    </label>

    <div class="row2">
      <label>Truck Full Inches (fallback)
        <input id="resTruckFullIn" type="number" placeholder="e.g., 120">
        <div class="muted">Linear inches fallback for the truck tank counter.</div>
      </label>
      <label>Truck Remaining Inches
        <input id="resTruckRemainIn" type="text" placeholder="0" readonly>
        <div class="muted">Updates as SCF is allocated to tanks.</div>
      </label>
    </div>

    <label>Tank 1 SCF
      <input id="resT1" type="number" placeholder="0">
    </label>

    <label>Tank 2 SCF
      <input id="resT2" type="number" placeholder="0">
    </label>

    <label>Tank 3 SCF
      <input id="resT3" type="number" placeholder="0">
    </label>

    <label>Remaining SCF
      <input id="resRemaining" type="text" placeholder="0" readonly>
    </label>

    <div class="sticky-actions">
      <button class="btn-ghost" type="button" onclick="window.goToCalc()">‚Üê Home</button>
      <button id="resClear" class="btn-clear" type="button" style="width:100%;">Clear</button>
    </div>
  </div>
</section>
<!-- === PAGE: RESERVE END === -->

    </div>
    <div class="hint">
      <span class="swipe">Swipe left/right</span>
      <span class="dots"><span class="dot active" id="d0"></span><span class="dot" id="d1"></span><span class="dot" id="d2"></span></span>
    </div>
  </div>

  <!-- === PAGE: GEO MODAL START === -->
<style>
  .modal-card{max-height:92vh; overflow:auto; -webkit-overflow-scrolling:touch;}
  .geo-tabs{display:flex; gap:8px; margin:6px 0 10px;}
  .geo-tab{padding:6px 10px; border:1px solid #cbd5e1; border-radius:999px; background:Field; color:FieldText; cursor:pointer;}
  .geo-tab.active{background:#1a73e8; color:#fff; border-color:#1a73e8;}
  .pane-wrap{display:none;}
  .pane-wrap.active{display:block;}

  /* Photo Measure live overlay */
  .pm-top{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .pm-stage{
    position:relative; width:100%; aspect-ratio: 4 / 3; max-height:52vh;
    background:#111; border-radius:12px; overflow:hidden; border:1px solid #e5e7eb; margin-top:10px;
  }
  .pm-stage video, .pm-stage canvas{
    position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000;
  }
  .pm-stage video{ z-index:1; }
  .pm-stage canvas{ z-index:2; pointer-events:auto; } /* overlay for taps/draw */

  .pm-line-hint{font-size:12px; color:#666; margin-top:6px;}
  .pm-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  .pm-actions .btn{width:auto;}
  .pm-actions .btn-primary{background:#1a73e8;}

  .modal .actions{
    position:sticky; bottom:0; background:Canvas; padding-top:10px; margin-top:10px;
    display:flex; gap:8px; justify-content:flex-end; border-top:1px solid #e5e7eb;
  }
</style>

<div id="geoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="geoTitle">
  <div class="modal-card">
    <h3 id="geoTitle">Horizontal Tank Tools</h3>

    <div class="geo-tabs" role="tablist">
      <button id="tabGeoPins" class="geo-tab active" role="tab" aria-selected="true">Geo Pins (A-B-C)</button>
      <button id="tabPhoto"   class="geo-tab" role="tab" aria-selected="false">Photo Measure</button>
    </div>

    <!-- ===== GEO PINS (unchanged UI) ===== -->
    <div id="geoPinsPane" class="pane-wrap active">
      <div class="steps">
        <div class="badge"><b>A</b></div> Drop Pin A at one end. <br>
        <div class="badge"><b>B</b></div> Drop Pin B at the other end (Length). <br>
        <div class="badge"><b>C</b></div> From A, walk perpendicular and drop Pin C (Diameter).
      </div>

      <div class="row" style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0;">
        <button id="dropA" class="btn btn-primary pill">Drop Pin A</button>
        <button id="dropB" class="btn btn-primary pill" disabled>Drop Pin B</button>
        <button id="dropC" class="btn btn-primary pill" disabled>Drop Pin C</button>
        <button id="resetGeo" class="btn btn-ghost pill">Reset</button>
      </div>

      <div id="geoStatus" class="muted">Pins: ‚Äî</div>
      <div id="geoResult" class="muted"></div>
    </div>

    <!-- ===== PHOTO MEASURE (live + sticky pins) ===== -->
    <div id="photoPane" class="pane-wrap">
      <div class="pm-top">
        <button id="pmOpenCam"  type="button" class="btn btn-primary">üì∑ Go Live</button>
        <button id="pmCloseCam" type="button" class="btn btn-clear" style="display:none;">Close</button>
        <div style="display:flex; align-items:center; gap:8px; margin-left:auto;">
          <label class="muted">Diameter (in)</label>
          <input id="pmRefIn" type="number" inputmode="decimal" placeholder="e.g. 36" style="max-width:140px;">
          <button id="pmSet" type="button" class="btn btn-primary" disabled>Set</button>
        </div>
      </div>

      <div class="pm-stage" id="pmStage">
        <video id="pmVideo" playsinline></video>
        <!-- Overlay canvas: handles double taps & drawing pins/lines -->
        <canvas id="pmCanvas"></canvas>
      </div>

      <div class="pm-line-hint">
        Double-tap 3 times on the live view to mark <b>C</b> (far diameter) ‚Üí <b>A</b> (near length) ‚Üí <b>B</b> (far length). Lines will stick C‚ÜíA and A‚ÜíB. Then press <b>Set</b>.
      </div>
    </div>

    <div class="actions">
      <button id="geoCancel" class="btn-ghost">Close</button>
    </div>
  </div>
</div>
<!-- === PAGE: GEO MODAL END === -->

<!-- === SCRIPTS: GEO MODAL START === -->
<script>
(function(){
  const modal=document.getElementById('geoModal');
  const tankType=document.getElementById('tankType');
  const btnMeasure=document.getElementById('btnMeasure');
  const geoCancel=document.getElementById('geoCancel');

  // Targets on the main page
  const geoFields=document.getElementById('geoFields');
  const geoDiameter=document.getElementById('geoDiameter');
  const geoLength=document.getElementById('geoLength');
  const diamHint=document.getElementById('diamHint');

  function revealGeoFields(){ if(geoFields)geoFields.hidden=false; if(geoDiameter)geoDiameter.disabled=false; if(geoLength)geoLength.disabled=false; if(diamHint)diamHint.hidden=false; }
  function putVal(el,val){ if(!el||!isFinite(val))return; el.value=Math.round(val); el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }

  /* ---------- Tabs (keep Geo Pins tab available) ---------- */
  const tabGeoPins=document.getElementById('tabGeoPins');
  const tabPhoto=document.getElementById('tabPhoto');
  const geoPinsPane=document.getElementById('geoPinsPane');
  const photoPane=document.getElementById('photoPane');
  function switchTab(which){
    const pins=(which==='pins');
    tabGeoPins.classList.toggle('active',pins);
    tabPhoto.classList.toggle('active',!pins);
    geoPinsPane.classList.toggle('active',pins);
    photoPane.classList.toggle('active',!pins);
    if(!pins){ // open camera automatically when going to Photo
      openCamera();
    } else {
      closeCamera();
    }
  }
  tabGeoPins?.addEventListener('click',()=>switchTab('pins'));
  tabPhoto?.addEventListener('click',()=>switchTab('photo'));

  /* ---------- Geo Pins (unchanged behavior) ---------- */
  const dropA=document.getElementById('dropA');
  const dropB=document.getElementById('dropB');
  const dropC=document.getElementById('dropC');
  const resetGeo=document.getElementById('resetGeo');
  const geoStatus=document.getElementById('geoStatus');
  const geoResult=document.getElementById('geoResult');
  const mToIn=m=>m*39.37007874;
  function haversine(p1,p2){
    const R=6371000,toRad=x=>x*Math.PI/180;
    const dLat=toRad(p2.lat-p1.lat), dLon=toRad(p2.lon-p1.lon);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(p1.lat))*Math.cos(toRad(p2.lat))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }
  let pins={A:null,B:null,C:null};
  function updatePinsUI(){
    const set=(pins.A?'A ':'')+(pins.B?'B ':'')+(pins.C?'C':'');
    if(geoStatus) geoStatus.textContent=`Pins: ${set||'‚Äî'}`;
    let parts=[];
    if(pins.A&&pins.B) parts.push(`Length AB ‚âà ${mToIn(haversine(pins.A,pins.B)).toFixed(0)} in`);
    if(pins.A&&pins.C) parts.push(`Diameter AC ‚âà ${mToIn(haversine(pins.A,pins.C)).toFixed(0)} in`);
    if(geoResult) geoResult.textContent=parts.join(' ‚Ä¢ ');
  }
  function getFix(cb){
    if(!navigator.geolocation){alert('Geolocation not supported');return;}
    navigator.geolocation.getCurrentPosition(
      pos=>cb({lat:pos.coords.latitude, lon:pos.coords.longitude}),
      err=>alert('Location error: '+err.message),
      {enableHighAccuracy:true,maximumAge:0,timeout:15000}
    );
  }
  function resetPins(){ pins={A:null,B:null,C:null}; if(dropA)dropA.disabled=false; if(dropB)dropB.disabled=true; if(dropC)dropC.disabled=true; updatePinsUI(); }
  dropA?.addEventListener('click',()=>getFix(p=>{pins.A=p; if(dropA)dropA.disabled=true; if(dropB)dropB.disabled=false; updatePinsUI();}));
  dropB?.addEventListener('click',()=>getFix(p=>{pins.B=p; if(dropB)dropB.disabled=true; if(dropC)dropC.disabled=false; updatePinsUI();}));
  dropC?.addEventListener('click',()=>getFix(p=>{pins.C=p; if(dropC)dropC.disabled=true; updatePinsUI();}));
  resetGeo?.addEventListener('click',resetPins);

  /* ---------- Photo Measure: live + sticky C-A-B ---------- */
  const pmOpenCam=document.getElementById('pmOpenCam');
  const pmCloseCam=document.getElementById('pmCloseCam');
  const pmVideo=document.getElementById('pmVideo');
  const pmCanvas=document.getElementById('pmCanvas');
  const pmStage=document.getElementById('pmStage');
  const pmSet=document.getElementById('pmSet');
  const pmRefIn=document.getElementById('pmRefIn');
  const ctx=pmCanvas.getContext('2d');

  let stream=null;
  let pts=[]; // order: [C, A, B] in canvas coords

  function sizeCanvas(){
    const r=pmStage.getBoundingClientRect();
    pmCanvas.width=r.width; pmCanvas.height=r.height;
    drawOverlay();
  }

  function drawOverlay(){
    const c=pmCanvas; const w=c.width, h=c.height;
    ctx.clearRect(0,0,w,h);
    // Draw lines
    ctx.lineWidth=3; ctx.strokeStyle='#22c55e';
    if(pts[0] && pts[1]){ ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y); ctx.lineTo(pts[1].x,pts[1].y); ctx.stroke(); }
    if(pts[1] && pts[2]){ ctx.beginPath(); ctx.moveTo(pts[1].x,pts[1].y); ctx.lineTo(pts[2].x,pts[2].y); ctx.stroke(); }
    // Draw points
    ctx.fillStyle='#60a5fa';
    pts.forEach((p,i)=>{ ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#fff'; ctx.font='bold 12px system-ui, -apple-system, Segoe UI, Roboto';
      const label = i===0?'C':(i===1?'A':'B');
      ctx.fillText(label, p.x+8, p.y-8);
      ctx.fillStyle='#60a5fa';
    });
  }

  // double-tap detector
  let lastTap=0;
  function handleTap(e){
    const now=Date.now();
    if(now-lastTap>350){ lastTap=now; return; } // first tap
    lastTap=0; // second tap within window
    const r=pmCanvas.getBoundingClientRect();
    const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
    const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
    if(pts.length<3){
      pts.push({x,y});
      drawOverlay();
      if(pts.length===3){ pmSet.disabled=false; }
    } else {
      // reset cycle if user continues
      pts=[{x,y}]; pmSet.disabled=true; drawOverlay();
    }
  }
  pmCanvas.addEventListener('touchstart', handleTap, {passive:true});
  pmCanvas.addEventListener('mousedown', handleTap);

  function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }

  async function openCamera(){
    try{
      if(stream) return;
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
      pmVideo.srcObject=stream;
      pmVideo.muted=true; pmVideo.playsInline=true;
      await pmVideo.play();
      pmOpenCam.style.display='none';
      pmCloseCam.style.display='inline-block';
      sizeCanvas();
      window.addEventListener('resize', sizeCanvas);
      pts=[]; pmSet.disabled=true; drawOverlay();
    }catch(e){
      alert('Camera error: '+ e.message);
    }
  }
  function closeCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    pmVideo.pause(); pmVideo.srcObject=null;
    pmOpenCam.style.display='inline-block';
    pmCloseCam.style.display='none';
    window.removeEventListener('resize', sizeCanvas);
  }
  pmOpenCam?.addEventListener('click', openCamera);
  pmCloseCam?.addEventListener('click', closeCamera);

  // Set ‚Üí compute scale using CA as diameter, compute length from AB, write into form, close modal
  pmSet?.addEventListener('click', ()=>{
    if(pts.length<3){ alert('Double-tap to place C, A, and B first.'); return; }
    let diamIn = parseFloat(pmRefIn.value);
    if(!isFinite(diamIn) || diamIn<=0){
      const s = prompt('Enter the tank diameter in inches:', pmRefIn.value || '');
      diamIn = parseFloat(s);
    }
    if(!isFinite(diamIn) || diamIn<=0){ return; }

    const CApx = dist(pts[0], pts[1]);
    const ABpx = dist(pts[1], pts[2]);
    if(CApx<=0 || ABpx<=0){ alert('Invalid points. Please re-mark C, A, B.'); return; }

    const pxPerIn = CApx / diamIn;                 // scale from CA
    const lengthIn = ABpx / pxPerIn;               // length from AB

    revealGeoFields();
    putVal(geoDiameter, diamIn);
    putVal(geoLength, lengthIn);
    if(diamHint){ diamHint.textContent = `Photo pins set ‚Äî Diameter ${diamIn.toFixed(1)} in, Length ${lengthIn.toFixed(1)} in.`; }

    // reset and close
    pts=[]; drawOverlay();
    closeCamera();
    modal.classList.remove('open');
  });

  function openModal(defTab='photo'){
    modal.classList.add('open');
    switchTab(defTab);       // opens camera when photo tab active
    sizeCanvas();
  }
  function closeModal(){ modal.classList.remove('open'); closeCamera(); }
  geoCancel?.addEventListener('click', closeModal);

  tankType?.addEventListener('change', ()=>{ if(tankType.value==='laydown') openModal('photo'); });
  btnMeasure?.addEventListener('click', ()=> openModal('photo'));

  // expose if needed
  window.__openGeoModal = openModal;
})();
</script>
<!-- === SCRIPTS: GEO MODAL END === -->

  <!-- === SCRIPTS: CALCULATOR START === -->
<script>
(function(){
  /* ----- Gas constants (define if missing) ----- */
  // You can tweak these to match your operation‚Äôs tables.
  // Defaults are typical STP approximations used in industry.
  window.gases = window.gases || {
    LIN: { scfPerGal: 93.1,  lbPerGal: 6.74, scfPerLb: 13.8  },  // Nitrogen
    LOX: { scfPerGal: 115.0, lbPerGal: 9.52, scfPerLb: 12.06 },  // Oxygen
    LAR: { scfPerGal: 87.3,  lbPerGal: 9.40, scfPerLb: 9.30  }   // Argon
  };

  /* ----- UI: show/hide laydown-only fields ----- */
  const tankTypeSel = document.getElementById('tankType');
  const geoFields   = document.getElementById('geoFields');
  const geoDiameter = document.getElementById('geoDiameter');
  const geoLength   = document.getElementById('geoLength');
  const diamHint    = document.getElementById('diamHint');

  function setGeoVisibility() {
    const isLaydown = tankTypeSel && tankTypeSel.value === 'laydown';
    if (geoFields)   geoFields.hidden      = !isLaydown;
    if (geoDiameter) geoDiameter.disabled  = !isLaydown;
    if (geoLength)   geoLength.disabled    = !isLaydown;
    if (diamHint)    diamHint.hidden       = !isLaydown;
  }
  if (tankTypeSel) {
    tankTypeSel.addEventListener('change', setGeoVisibility);
    setGeoVisibility();
  }

  /* ----- TIMER (Start/Stop) ----- */
  let t0=null, t1=null, intervalId=null;
  const $elapsed  = document.getElementById('elapsed');
  const $btnStart = document.getElementById('btnStart');
  const $btnStop  = document.getElementById('btnStop');

  function fmtTime(ms){
    if (!ms || ms < 0) return "00:00:00";
    const s = Math.floor(ms/1000);
    const h = String(Math.floor(s/3600)).padStart(2,'0');
    const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const sec = String(s%60).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  }
  function updateElapsed(){
    if (!t0) return;
    const now = (t1 && Number.isFinite(t1)) ? t1 : Date.now();
    if ($elapsed) $elapsed.textContent = "Elapsed: " + fmtTime(now - t0);
  }
  function startTimer(){
    t0 = Date.now(); t1 = null;
    if ($elapsed) $elapsed.textContent = "Elapsed: 00:00:00";
    if (intervalId) clearInterval(intervalId);
    intervalId = setInterval(updateElapsed, 250);
    if ($btnStart) $btnStart.disabled = true;
    if ($btnStop)  $btnStop.disabled  = false;
  }
  function stopTimer(){
    if (!t0) return;
    t1 = Date.now();
    if (intervalId) clearInterval(intervalId);
    updateElapsed();
    if ($btnStart) $btnStart.disabled = false;
    if ($btnStop)  $btnStop.disabled  = true;
  }
  $btnStart?.addEventListener('click', startTimer);
  $btnStop ?.addEventListener('click', stopTimer);

  /* ----- Flow unit toggle (gal/min ‚Üî lb/min) ----- */
  const unitSwitch = document.getElementById('unitSwitch');
  function isLbMode(){ return unitSwitch && unitSwitch.classList.contains('on'); }
  function setUnitSwitch(on){
    if (!unitSwitch) return;
    unitSwitch.classList.toggle('on', !!on);
    unitSwitch.setAttribute('aria-checked', on ? 'true' : 'false');
  }
  unitSwitch?.addEventListener('click', ()=>setUnitSwitch(!isLbMode()));
  unitSwitch?.addEventListener('keydown', (e)=>{
    if (e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); setUnitSwitch(!isLbMode()); }
  });
  setUnitSwitch(false);

  /* ----- Geometry helpers for horizontal tanks ----- */
  function horizFrac(d, h){
    // d: cylinder diameter (in), h: liquid height (in)
    const R = d/2;
    if (!Number.isFinite(d) || !Number.isFinite(h)) return 0;
    if (h<=0)   return 0;
    if (h>=2*R) return 1;
    const a   = Math.acos((R-h)/R);
    const Aseg= R*R*a - (R-h)*Math.sqrt(Math.max(0,2*R*h - h*h));
    return Aseg/(Math.PI*R*R);
  }
  function estimateDiameterFromTimer(fullSCF,start,end,scfDelivered,dMin=60,dMax=130,step=0.1){
    let bestD=null,bestErr=Infinity;
    for(let d=dMin; d<=dMax; d+=step){
      const pred = fullSCF * (horizFrac(d,end) - horizFrac(d,start));
      const err  = Math.abs(pred - scfDelivered);
      if (err < bestErr){ bestErr = err; bestD = d; }
    }
    return { d: bestD, err: bestErr };
  }
  // subtract short ‚Äúdead time‚Äù for horizontal fills when using timer
  function adjustedElapsedMin(rawMin){
    if(!rawMin) return null;
    const deadSec = Math.min(30, Math.max(10, rawMin*60*0.05));
    return Math.max(0, rawMin - deadSec/60);
  }

  /* ----- CALCULATE (exposed for button onclick) ----- */
  window.calculate = function(){
    const tankType = document.getElementById('tankType')?.value || 'vertical';
    const gasKey   = document.getElementById('gas')?.value || 'LIN';
    const gas      = (window.gases && window.gases[gasKey]) ? window.gases[gasKey] : null;
    const output   = document.getElementById('output');

    if (!gas){
      output.innerHTML = 'Gas constants missing. Please verify LIN/LOX/LAR constants.';
      return;
    }

    const capUnit        = document.getElementById('capUnit')?.value || 'scf';
    const fullCapEntered = parseFloat(document.getElementById('fullCap')?.value);
    if (!Number.isFinite(fullCapEntered)){
      output.innerHTML = 'Please enter a valid Full Capacity value (SCF or Gallons).';
      return;
    }
    const fullSCF = (capUnit === 'gal') ? (fullCapEntered * gas.scfPerGal) : fullCapEntered;

    const start = parseFloat(document.getElementById('startInches')?.value);
    const end   = parseFloat(document.getElementById('endInches')?.value);

    const elapsedMs  = (t0 && (t1 || Date.now())) ? ((t1 || Date.now()) - t0) : null;
    let   elapsedMin = elapsedMs ? (elapsedMs/1000/60) : null;
    let   effectiveElapsedMin = elapsedMin;
    if (tankType === 'laydown' && elapsedMin && elapsedMin > 0){
      effectiveElapsedMin = adjustedElapsedMin(elapsedMin);
    }

    const flowVal = parseFloat(document.getElementById('flowValue')?.value);
    let flowGPM = null;
    if (Number.isFinite(flowVal)) flowGPM = isLbMode() ? (flowVal / gas.lbPerGal) : flowVal;
    const flowScfMin = flowGPM ? flowGPM * gas.scfPerGal : null;

    const wantEstimateD   = document.getElementById('chkEstimateD')?.checked;
    const useTimerPrimary = document.getElementById('useTimerPrimary')?.checked;

    const fullTrycockIn = parseFloat(document.getElementById('fullInches')?.value);
    const cylD = parseFloat(document.getElementById('geoDiameter')?.value);
    let html = '';

    /* Flow-only estimate if no inches provided */
    const inchesMissing = !Number.isFinite(start) || !Number.isFinite(end);
    if (flowGPM && effectiveElapsedMin && inchesMissing){
      const totalGallons = flowGPM * effectiveElapsedMin;
      const totalSCF     = totalGallons * gas.scfPerGal;
      const enteredLabel = isLbMode() ? `${flowVal.toFixed(1)} lb/min` : `${flowVal.toFixed(1)} gal/min`;
      html += `<h2>Flow-Only Estimate</h2>`;
      html += `<p>Elapsed Time: <b>${fmtTime(effectiveElapsedMin*60*1000)}</b> &nbsp; | &nbsp; Flow: <b>${enteredLabel}</b></p>`;
      html += `<p><b>Estimated Product Moved:</b> ${totalGallons.toFixed(1)} gal &nbsp; (~${totalSCF.toFixed(0)} SCF)</p><hr>`;
    }

    /* Timer-first path */
    let scf_timer = null;
    if (useTimerPrimary && effectiveElapsedMin && flowScfMin && flowScfMin > 0){
      scf_timer = flowScfMin * effectiveElapsedMin;
    }

    /* Inches-based path */
    let haveInches = Number.isFinite(start) && Number.isFinite(end) && Number.isFinite(fullSCF);
    let scf_inches = null, modeLabel = '', usedD = cylD, estNote = '', scfPerInchShown = null;

    if (haveInches){
      if (tankType === 'laydown'){
        if (Number.isFinite(cylD) && cylD > 0){
          const fs = horizFrac(cylD, Math.max(0,start));
          const fe = horizFrac(cylD, Math.max(0,end));
          scf_inches = fullSCF * (fe - fs);
          modeLabel = 'Laydown Tank (geometry)';
          const mid=(start+end)/2, eps=0.01;
          const df=(horizFrac(cylD,mid+eps)-horizFrac(cylD,mid-eps))/(2*eps);
          scfPerInchShown = fullSCF * df;
        } else if (wantEstimateD && effectiveElapsedMin && flowScfMin && flowScfMin>0){
          const scfDelivered = flowScfMin * effectiveElapsedMin;
          const { d } = estimateDiameterFromTimer(fullSCF, Math.max(0,start), Math.max(0,end), scfDelivered);
          if (d){ usedD = d; estNote = ` (estimated D: ${d.toFixed(1)} in)`; }
          const fs = horizFrac(usedD, Math.max(0,start));
          const fe = horizFrac(usedD, Math.max(0,end));
          scf_inches = fullSCF * (fe - fs);
          modeLabel = 'Laydown Tank (geometry, est. D)';
          const mid=(start+end)/2, eps=0.01;
          const df=(horizFrac(usedD,mid+eps)-horizFrac(usedD,mid-eps))/(2*eps);
          scfPerInchShown = fullSCF * df;
        } else if (Number.isFinite(fullTrycockIn) && fullTrycockIn > 0){
          // simple fallback if no diameter available
          const linearFactor = 0.94;
          scf_inches = (end - start) * (fullSCF / fullTrycockIn) * linearFactor;
          modeLabel = 'Laydown Tank (empirical linear)';
          scfPerInchShown = (fullSCF / fullTrycockIn) * linearFactor;
          html += `<p class="muted">Laydown fallback used: linear ratio √ó0.94 (no cylinder diameter provided).</p>`;
        } else {
          html += `<p class="muted">Provide cylinder diameter (or enable ‚ÄúEstimate diameter from timer‚Äù) to map laydown inches.</p>`;
        }
      } else {
        const denom = (Number.isFinite(fullTrycockIn)&&fullTrycockIn>0) ? fullTrycockIn : 1;
        const spi = fullSCF / denom;
        scf_inches = (end - start) * spi;
        modeLabel = 'Vertical Tank (linear)';
        scfPerInchShown = spi;
      }
    }

    /* Pick official result */
    let scf=null, source='';
    if (useTimerPrimary && scf_timer!=null){ scf = scf_timer; source = 'Timer √ó Flow (primary)'; }
    else if (haveInches && scf_inches!=null){ scf = scf_inches; source = (tankType==='laydown') ? 'Inches (geometry)' : 'Inches (linear)'; }
    else if (scf_timer!=null){ scf = scf_timer; source = 'Timer √ó Flow'; }

    if (scf==null){
      output.innerHTML = html + 'Not enough info. Provide inches OR enable timer with flow.';
      return;
    }

    const gallons = scf / gas.scfPerGal;
    const poundsFromGallons = gallons * gas.lbPerGal;
    const poundsFromSCF     = scf / gas.scfPerLb;

    let compLine = '';
    if (scf_timer!=null && scf_inches!=null){
      const pct = (scf_inches===0)?0:((scf_timer-scf_inches)/scf_inches)*100;
      compLine = `Timer vs Inches Œî: <b>${pct.toFixed(2)}%</b>`;
    }

    const flowFromTimerScfMin = (effectiveElapsedMin && effectiveElapsedMin>0) ? (scf / effectiveElapsedMin) : null;
    const flowFromTimerGPM    = flowFromTimerScfMin ? (flowFromTimerScfMin / gas.scfPerGal) : null;
    const flowFromTimerLBPM   = flowFromTimerGPM ? (flowFromTimerGPM * gas.lbPerGal) : null;

    html += `<h2>Results ‚Äî ${source}${modeLabel ? ' ‚Ä¢ ' + modeLabel : ''}</h2>`;
    if (haveInches){
      html += `<p>Change (in): ${(end-start).toFixed(2)}</p>`;
      if (tankType==='laydown' && (Number.isFinite(usedD) || Number.isFinite(cylD))){
        html += `<p>Diameter used: <b>${(Number.isFinite(cylD)?cylD:usedD).toFixed(2)} in</b>${estNote||''}</p>`;
      }
      if (Number.isFinite(scfPerInchShown)) html += `<p>Approx. SCF per inch (local): ${scfPerInchShown.toFixed(2)}</p>`;
    }
    if (compLine) html += `<p>${compLine}</p>`;

    html += `<hr>`;
    html += `<p><b>Total SCF (official):</b> ${scf.toFixed(2)}</p>`;
    html += `<p><b>Gallons (~SCF √∑ ${gas.scfPerGal}):</b> ${gallons.toFixed(2)}</p>`;
    html += `<p><b>Pounds (Gallons √ó ${gas.lbPerGal}):</b> ${poundsFromGallons.toFixed(2)}</p>`;
    html += `<p><b>Pounds (SCF √∑ ${gas.scfPerLb}):</b> ${poundsFromSCF.toFixed(2)}</p>`;
    html += `<p>Timer: <span class="mono">${elapsedMs ? fmtTime(elapsedMs) : '‚Äî'}</span>`;
    if (Number.isFinite(flowVal) && effectiveElapsedMin){
      const entered = isLbMode() ? `${flowVal.toFixed(1)} lb/min` : `${flowVal.toFixed(1)} gal/min`;
      html += ` &nbsp; | &nbsp; Entered Flow: <span class="mono">${entered}</span>`;
    }
    if (flowFromTimerGPM && effectiveElapsedMin){
      html += ` &nbsp; | &nbsp; Flow from timer + result: <span class="mono">${flowFromTimerGPM.toFixed(1)} gal/min</span>`;
      html += ` &nbsp; (<span class="mono">${flowFromTimerLBPM.toFixed(1)} lb/min</span>)`;
    }
    html += `</p>`;

    output.innerHTML = html;

    // push to Split page input
    if (typeof window.setAutoSCFTotal === 'function') {
      window.setAutoSCFTotal(Number(scf.toFixed(0)));
    }
  };

  /* ----- CLEAR (exposed for button onclick) ----- */
  window.clearForm = function(){
    ['fullInches','fullCap','startInches','endInches','flowValue','geoDiameter','geoLength'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.value='';
    });
    const capSel=document.getElementById('capUnit'); if(capSel) capSel.value='scf';
    const chk1=document.getElementById('chkEstimateD'); if(chk1) chk1.checked=false;
    const chk2=document.getElementById('useTimerPrimary'); if(chk2) chk2.checked=false;
    const out=document.getElementById('output'); if(out) out.innerHTML='Enter values and tap Calculate.';
    if ($elapsed) $elapsed.textContent='Elapsed: 00:00:00';
    if (intervalId) clearInterval(intervalId);
    t0=null; t1=null; intervalId=null;
    if (unitSwitch){
      unitSwitch.classList.remove('on');
      unitSwitch.setAttribute('aria-checked','false');
    }
    if ($btnStart) $btnStart.disabled=false;
    if ($btnStop)  $btnStop.disabled=true;
    setGeoVisibility();
  };
})();
</script>
<!-- === SCRIPTS: CALCULATOR END === -->

  <!-- === SCRIPTS: SPLIT START === -->
<script>
(function(){
  /* Ensure gas constants exist (same defaults as calculator) */
  window.gases = window.gases || {
    LIN: { scfPerGal: 93.1,  lbPerGal: 6.74, scfPerLb: 13.8  },  // Nitrogen
    LOX: { scfPerGal: 115.0, lbPerGal: 9.52, scfPerLb: 12.06 },  // Oxygen
    LAR: { scfPerGal: 87.3,  lbPerGal: 9.40, scfPerLb: 9.30  }   // Argon
  };

  const $ = id => document.getElementById(id);
  const toNum = v => { const n=parseFloat(v); return (Number.isFinite(n)?n:0); };
  const fmt0 = n => Number.isFinite(n) ? Number(n).toLocaleString(undefined,{maximumFractionDigits:0}) : '‚Äî';
  const fmt1 = n => Number.isFinite(n) ? Number(n).toLocaleString(undefined,{maximumFractionDigits:1}) : '‚Äî';

  const splitRoot  = document.querySelector('#pane-split .page');
  const totalScfEl = $('totalScf');
  const err        = $('err');

  const t1s=$('t1s'), t1e=$('t1e'), t1a=$('t1alloc'), t1Cap=$('t1Cap');
  const t2s=$('t2s'), t2e=$('t2e'), t2a=$('t2alloc'), t2Cap=$('t2Cap');

  /* ---- Inject new top UI (Gas dropdown next to Total SCF, Update button beneath) ---- */
  (function injectTopUI(){
    if (!splitRoot || !totalScfEl) return;

    // Wrap Total SCF + Gas in a 2-col row
    let topRow = document.getElementById('splitTopRow');
    if (!topRow){
      topRow = document.createElement('div');
      topRow.id = 'splitTopRow';
      topRow.style.display = 'grid';
      topRow.style.gridTemplateColumns = '1fr 1fr';
      topRow.style.gap = '10px';
      topRow.style.marginTop = '8px';

      // Find the "Total SCF" label and move it into col 1
      const totalLabel = totalScfEl.closest('label');
      if (totalLabel){
        topRow.appendChild(totalLabel);
      }

      // Create Gas dropdown (col 2)
      const gasWrap = document.createElement('label');
      gasWrap.id = 'splitGasWrap';
      gasWrap.innerHTML = `
        Gas (for SCF ‚áÑ gallons)
        <select id="splitGas" style="margin-top:6px;">
          <option value="LIN">LIN (Nitrogen)</option>
          <option value="LOX">LOX (Oxygen)</option>
          <option value="LAR">LAR (Argon)</option>
        </select>
      `;
      topRow.appendChild(gasWrap);

      // Insert row under the H1
      const h1 = splitRoot.querySelector('h1');
      splitRoot.insertBefore(topRow, h1.nextSibling);
    }

    // Second line: Update button + translated hint
    if (!document.getElementById('splitUpdateRow')){
      const row2 = document.createElement('div');
      row2.id = 'splitUpdateRow';
      row2.style.display = 'flex';
      row2.style.alignItems = 'center';
      row2.style.gap = '10px';
      row2.style.marginTop = '8px';

      const btn = document.createElement('button');
      btn.id = 'splitUpdate';
      btn.type = 'button';
      btn.className = 'btn btn-primary';
      btn.textContent = 'Update';
      row2.appendChild(btn);

      const hint = document.createElement('div');
      hint.id = 'splitHint';
      hint.className = 'muted';
      row2.appendChild(hint);

      splitRoot.insertBefore(row2, topRow.nextSibling);
    }
  })();

  const splitGasSel = () => document.getElementById('splitGas');
  const splitHint   = () => document.getElementById('splitHint');

  function updateTopHint(){
    const gasSel = splitGasSel();
    const gas    = gasSel && window.gases[gasSel.value];
    const hint   = splitHint();
    const scf    = toNum(totalScfEl?.value);
    if (!hint){ return; }
    if (!gas || !scf){
      hint.textContent = '';
      return;
    }
    const gal = scf / gas.scfPerGal;
    hint.textContent = `‚âà ${fmt1(gal)} gallons (${gasSel.value}) from Total SCF`;
  }

  $('splitUpdate')?.addEventListener('click', updateTopHint);
  document.addEventListener('change', (e)=>{ if (e.target && e.target.id==='splitGas') updateTopHint(); });

  /* ---- Rework Tank 1/2 top rows: replace "Units" select with Full Trycock (in) ---- */
  function replaceUnitsWithFullTrycock(unitsSelectId, fullId){
    const sel = $(unitsSelectId);
    if (!sel) return null;
    const holderLabel = sel.closest('label');
    if (!holderLabel) return null;

    // Hide original select (keep in DOM for compatibility)
    sel.style.display = 'none';

    // Replace label content
    holderLabel.innerHTML = `
      Full Trycock (in)
      <input id="${fullId}" type="number" placeholder="e.g., 120" />
    `;
    const input = document.getElementById(fullId);
    return input;
  }

  const t1FullIn = replaceUnitsWithFullTrycock('t1unit', 't1FullIn');
  const t2FullIn = replaceUnitsWithFullTrycock('t2unit', 't2FullIn');

  // Add gallon hints under each allocated SCF field (keep your existing readonly)
  function ensureHint(afterInput, id){
    if (!afterInput) return null;
    let hint = document.getElementById(id);
    if (!hint){
      hint = document.createElement('div');
      hint.id = id;
      hint.className = 'muted';
      hint.style.marginTop = '4px';
      hint.textContent = '';
      afterInput.parentElement.appendChild(hint);
    }
    return hint;
  }
  const t1galHint = ensureHint(t1a, 't1galHint');
  const t2galHint = ensureHint(t2a, 't2galHint');

  function showErr(msg){ if(err){err.textContent=msg;err.style.display='';} }
  function hideErr(){ if(err) err.style.display='none'; }

  function updatePerTankGallons(a1SCF, a2SCF){
    const sel = splitGasSel();
    const gas = sel && window.gases[sel.value] ? window.gases[sel.value] : null;
    if (!gas){
      if (t1galHint) t1galHint.textContent = '';
      if (t2galHint) t2galHint.textContent = '';
      return;
    }
    if (t1galHint) t1galHint.textContent = Number.isFinite(a1SCF) ? `‚âà ${fmt1(a1SCF / gas.scfPerGal)} gal (${sel.value})` : '';
    if (t2galHint) t2galHint.textContent = Number.isFinite(a2SCF) ? `‚âà ${fmt1(a2SCF / gas.scfPerGal)} gal (${sel.value})` : '';
  }

  /* ---- Calculate: ALWAYS use inch deltas (Start/End) proportionally ---- */
  function calcSplit(){
    hideErr();
    const scfTotal = toNum(totalScfEl?.value);

    const d1 = Math.max(0, toNum(t1e?.value) - toNum(t1s?.value));
    const d2 = Math.max(0, toNum(t2e?.value) - toNum(t2s?.value));

    if(!scfTotal || d1<=0 || d2<=0){
      showErr('Enter Total SCF and valid Start/End for both tanks. End must be greater than Start.');
      if (t1a) t1a.value=''; if (t2a) t2a.value='';
      updatePerTankGallons(NaN, NaN);
      return;
    }

    // Proportional allocation by inch change
    const sum = d1 + d2;
    let a1 = Math.round((d1/sum) * scfTotal);
    let a2 = Math.round((d2/sum) * scfTotal);

    // Nudge to exact total
    a2 += (scfTotal - (a1 + a2));

    if (t1a) t1a.value = fmt0(a1);
    if (t2a) t2a.value = fmt0(a2);

    updatePerTankGallons(a1, a2);
  }

  $('calcSplit')?.addEventListener('click', calcSplit);

  $('clearSplit')?.addEventListener('click',()=>{
    ['totalScf','t1s','t1e','t2s','t2e','t1alloc','t2alloc','t1Cap','t2Cap','t1FullIn','t2FullIn'].forEach(id=>{
      const el=$(id); if(el) el.value='';
    });
    if (t1galHint) t1galHint.textContent = '';
    if (t2galHint) t2galHint.textContent = '';
    if (splitHint()) splitHint().textContent = '';
    hideErr();
  });

  // Expose a helper so Calculator can auto-fill Total SCF
  window.setAutoSCFTotal = n => {
    const x=parseFloat(n);
    if(Number.isFinite(x)&&x>=0 && totalScfEl) totalScfEl.value=Math.round(x);
  };
})();
</script>
<!-- === SCRIPTS: SPLIT END === -->

  <!-- === SCRIPTS: RESERVE START === -->
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const toNum = (v)=>{ const n=parseFloat(v); return isFinite(n)?n:0; };

  const resGallons=$('resGallons'), resUpdate=$('resUpdate'), resHint=$('resHint');
  const resGas=$('resGas');
  const resT1=$('resT1'), resT2=$('resT2'), resT3=$('resT3');
  const resRemaining=$('resRemaining');
  const resTruckFullIn=$('resTruckFullIn'), resTruckRemainIn=$('resTruckRemainIn');
  const resClear=$('resClear');

  let maxSCF = 0;      // usable SCF pool (capped at 999,999)
  let calcSCF = 0;     // uncapped informational SCF

  // Enforce 6-digit max on the pounds input
  if (resGallons){
    resGallons.addEventListener('input', ()=>{
      resGallons.value = (resGallons.value || '').replace(/\D+/g,'').slice(0,6);
    });
  }

  function updateTruckInches(remaining){
    const fullIn = toNum(resTruckFullIn.value);
    if (!maxSCF || !fullIn){
      resTruckRemainIn.value = fullIn ? String(fullIn) : '0';
      return;
    }
    const ratio = Math.max(0, remaining / maxSCF);
    resTruckRemainIn.value = String(Math.round(fullIn * ratio));
  }

  function recomputeRemaining(lastChangedEl){
    const t1 = toNum(resT1.value);
    const t2 = toNum(resT2.value);
    const t3 = toNum(resT3.value);
    let sum = t1 + t2 + t3;

    // Clamp last input if exceeding total SCF
    if (maxSCF > 0 && sum > maxSCF && lastChangedEl){
      const others = sum - toNum(lastChangedEl.value);
      const allowed = Math.max(0, maxSCF - others);
      lastChangedEl.value = String(allowed);
      sum = others + allowed;
    }

    const remaining = Math.max(0, maxSCF - sum);
    resRemaining.value = remaining.toLocaleString(undefined,{maximumFractionDigits:0});

    if (sum > maxSCF && maxSCF > 0){
      resRemaining.style.color = '#b42318';
      resRemaining.value = 'Exceeded!';
    } else {
      resRemaining.style.color = '';
    }

    updateTruckInches(remaining);
  }

  [resT1,resT2,resT3].forEach(el=>{
    if(el){
      el.addEventListener('input', (e)=>{
        if (toNum(e.target.value) < 0) e.target.value = '0';
        recomputeRemaining(e.target);
      });
    }
  });

  if (resTruckFullIn){
    resTruckFullIn.addEventListener('input', ()=> recomputeRemaining());
  }

  // Convert pounds ‚Üí SCF (capped) on Update click
  if(resUpdate){
    resUpdate.addEventListener('click', ()=>{
      const lbs = toNum(resGallons?.value);           // <-- treat this field as POUNDS
      const gasKey = (resGas && resGas.value) || 'LIN';
      const gas = window.gases?.[gasKey];

      if(!lbs || !gas){
        if(resHint) resHint.textContent = '';
        maxSCF = 0; calcSCF = 0;
        resRemaining.value = '0';
        updateTruckInches(0);
        return;
      }

      calcSCF = Math.round(lbs * gas.scfPerLb);       // lbs ‚Üí SCF
      maxSCF  = Math.min(999999, calcSCF);            // 6-digit cap

      if (resHint){
        resHint.textContent = (calcSCF > 999999)
          ? `‚âà ${calcSCF.toLocaleString()} SCF (capped to 999,999 for counter)`
          : `‚âà ${calcSCF.toLocaleString()} SCF`;
      }

      // Clamp any tank values already entered
      [resT1,resT2,resT3].forEach(el=>{
        if (el && toNum(el.value) > maxSCF){ el.value = String(maxSCF); }
      });

      resRemaining.value = maxSCF.toLocaleString();
      recomputeRemaining();
    });
  }

  if(resClear){
    resClear.addEventListener('click', ()=>{
      [resGallons,resT1,resT2,resT3,resTruckFullIn].forEach(el=>{ if(el) el.value = ''; });
      if(resHint) resHint.textContent = '';
      resRemaining.value = '0';
      if(resTruckRemainIn) resTruckRemainIn.value = '0';
      maxSCF = 0; calcSCF = 0;
    });
  }
})();
</script>
<!-- === SCRIPTS: RESERVE END === -->

  <!-- === SCRIPTS: TESTS START === -->
  <script>
    /* Minimal inline tests (run with ?test=1) */
    (function(){
      if (!/([?&])test=1(?!\d)/.test(location.search)) return;
      console.log('[TEST] Starting UI nav tests');
      try {
        console.assert(typeof window.goToSplit === 'function', 'goToSplit should be a function');
        console.assert(typeof window.goToReserve === 'function', 'goToReserve should be a function');
        console.assert(typeof window.goToCalc === 'function', 'goToCalc should be a function');
        window.goToSplit();
        setTimeout(()=>{
          console.assert(document.getElementById('panes').getAttribute('data-index')==='1', 'Should be on Split pane');
          window.goToReserve();
          setTimeout(()=>{
            console.assert(document.getElementById('panes').getAttribute('data-index')==='2', 'Should be on Reserve pane');
            window.goToCalc();
            setTimeout(()=>{
              console.assert(document.getElementById('panes').getAttribute('data-index')==='0', 'Should be on Calc pane');
              console.log('[TEST] Navigation tests passed');
            }, 50);
          }, 50);
        }, 50);
      } catch(e){ console.error('[TEST] Failed', e); }
    })();
  </script>
  <!-- === SCRIPTS: TESTS END === -->
<!-- === SCRIPTS: NAV (Swipe + Buttons) START === -->
<script>
(function(){
  const panes   = document.getElementById('panes');
  const viewport= document.getElementById('viewport');
  const dots    = [document.getElementById('d0'), document.getElementById('d1'), document.getElementById('d2')];

  let index = Number(panes?.dataset.index || 0);

  function setIndex(i){
    index = Math.max(0, Math.min(2, i));
    if (panes) panes.setAttribute('data-index', String(index));
    dots.forEach((d,k)=>{ if(d) d.classList.toggle('active', k===index); });
  }

  // Expose for buttons
  window.goToCalc    = ()=> setIndex(0);
  window.goToSplit   = ()=> setIndex(1);
  window.goToReserve = ()=> setIndex(2);

  // Swipe handling
  let startX=0, startY=0, startTime=0;
  const THRESHOLD = 35;   // min X distance
  const RESTRAINT = 80;   // max Y drift
  const ALLOWED   = 600;  // max time (ms)

  viewport?.addEventListener('touchstart', (e)=>{
    const t = e.changedTouches[0];
    startX = t.pageX; startY = t.pageY; startTime = Date.now();
  }, {passive:true});

  viewport?.addEventListener('touchend', (e)=>{
    const t = e.changedTouches[0];
    const distX = t.pageX - startX;
    const distY = t.pageY - startY;
    const elapsed = Date.now() - startTime;

    if (elapsed <= ALLOWED && Math.abs(distX) >= THRESHOLD && Math.abs(distY) <= RESTRAINT){
      if (distX < 0) setIndex(index + 1); // swipe left ‚Üí next pane
      else           setIndex(index - 1); // swipe right ‚Üí prev pane
    }
  }, {passive:true});

  // Keyboard support
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'ArrowLeft')  setIndex(index - 1);
    if (e.key === 'ArrowRight') setIndex(index + 1);
  });

  // Initialize
  setIndex(index);
})();
</script>
<!-- === SCRIPTS: NAV (Swipe + Buttons) END === -->
</body>
</html>
